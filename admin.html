<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æ•°æ®ç®¡ç†</title>
    <link rel="icon" href="imgs/heart.png" type="image/png">
    <!-- å¼•å…¥ç½‘ç«™å…¨å±€æ ·å¼ -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- å¼•å…¥Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- å¼•å…¥Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- å¼•å…¥Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@6.4.0/css/all.min.css">
    <style>
        /* ç®¡ç†é¡µé¢ç‰¹å®šæ ·å¼ */
        
        main {
            margin-top: 80px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            padding: var(--spacing-xl) 0;
            min-height: calc(100vh - 80px);
            box-sizing: border-box;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
        }
        
        .admin-header {
            background-color: var(--card-bg);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .admin-header h1 {
            font-family: var(--pixel-font);
            color: var(--primary-purple);
            margin: 0;
            font-size: 1.8rem;
        }
        
        .admin-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }
        
        .admin-card-header {
            background-color: var(--primary-purple);
            color: white;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
        }
        
        .admin-card-body {
            padding: var(--spacing-lg);
        }
        
        .btn-action {
            margin: 0 5px;
        }
        
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: var(--subtitle-font-weight);
        }
        
        .status-published {
            background-color: var(--accent-green);
            color: white;
        }
        
        .status-warning {
            background-color: var(--accent-orange);
            color: black;
        }
        
        .status-error {
            background-color: var(--primary-red);
            color: white;
        }
        
        .status-info {
            background-color: var(--primary-blue);
            color: white;
        }
        
        /* è¡¨æ ¼æ ·å¼ä¿®å¤ */
        .table {
            color: var(--text-dark) !important;
        }
        
        /* ç¡®ä¿è¡¨æ ¼æ‰€æœ‰å•å…ƒæ ¼æ–‡å­—é¢œè‰²æ­£ç¡® */
        .table th,
        .table td,
        .table tbody tr,
        .table tbody td {
            color: var(--text-dark) !important;
            background-color: transparent !important;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }
        
        [data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }
        
        .table-bordered th,
        .table-bordered td {
            border-color: var(--border-light) !important;
        }
        
        .game-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            margin-right: 5px;
            font-weight: var(--subtitle-font-weight);
        }
        
        .game-undertale {
            background-color: var(--primary-red);
            color: white;
        }
        
        .game-deltarune {
            background-color: var(--primary-cyan);
            color: white;
        }
        
        /* SAPæ¨¡å¼æ ·å¼ */
        .sap-container {
            position: relative;
            min-height: 500px;
        }
        
        .sap-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .sap-section.active {
            display: block;
        }
        
        /* å¯¼èˆªèœå•æ ·å¼ */
        .nav-menu {
            display: flex;
            gap: var(--spacing-sm);
            margin: 0;
            padding: 0;
            list-style: none;
        }

        /* ç¡®ä¿å¯¼èˆªé“¾æ¥æ ·å¼ä¼˜å…ˆäºBootstrap */
        .navbar .nav-link {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-normal);
            position: relative;
            font-size: 0.95rem;
        }

        .navbar .nav-link:hover,
        .navbar .nav-link.active {
            color: var(--primary-purple);
            background-color: rgba(124, 58, 237, 0.05);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.4);
            padding-left: var(--spacing-lg);
        }

        .navbar .nav-link.active::before {
            content: url('imgs/heart.png');
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .navbar-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        /* ç¡®ä¿BootstrapæŒ‰é’®æ ·å¼æ­£å¸¸å·¥ä½œ */
        .navbar-controls .btn {
            margin-right: 5px;
        }
        
        .navbar-controls .btn-primary {
            background-color: var(--primary-purple);
            border-color: var(--primary-purple);
        }
        
        .navbar-controls .btn-primary:hover {
            background-color: var(--secondary-purple);
            border-color: var(--secondary-purple);
        }
        
        .navbar-controls .btn-info {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        .navbar-controls .btn-info:hover {
            background-color: var(--secondary-blue);
            border-color: var(--secondary-blue);
        }
        
        /* æ¨¡æ€æ¡†æ·±è‰²æ¨¡å¼é€‚é… */
        .modal-content {
            background-color: var(--card-bg) !important;
            color: var(--text-dark) !important;
            border: 1px solid var(--border-light) !important;
        }
        
        .modal-header {
            background-color: var(--primary-purple) !important;
            color: white !important;
            border-bottom: 1px solid var(--border-light) !important;
        }
        
        .modal-title {
            color: white !important;
        }
        
        .modal-body {
            background-color: var(--card-bg) !important;
            color: var(--text-dark) !important;
        }
        
        .modal-footer {
            background-color: var(--card-bg) !important;
            border-top: 1px solid var(--border-light) !important;
        }
        
        .modal-body label {
            color: var(--text-medium) !important;
        }
        
        .modal-body input,
        .modal-body textarea,
        .modal-body select {
            background-color: var(--card-bg) !important;
            color: var(--text-dark) !important;
            border: 1px solid var(--border-light) !important;
        }
        
        .modal-body input:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            border-color: var(--primary-purple) !important;
            box-shadow: 0 0 0 0.2rem rgba(124, 58, 237, 0.25) !important;
        }
        
        .close {
            color: white !important;
            opacity: 1 !important;
        }
        
        .close:hover {
            color: var(--text-light) !important;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <header class="navbar">
        <div class="container">
            <div class="logo">
                <h1>CSZXYWJ ç®¡ç†æ¨¡å¼</h1>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-link active" onclick="switchSection('videos', event); return false;">è§†é¢‘ç®¡ç†</a>
                <a href="#" class="nav-link" onclick="switchSection('notifications', event); return false;">é€šçŸ¥ç®¡ç†</a>
                <a href="#" class="nav-link" onclick="switchSection('update-preview', event); return false;">é¢„å‘Šç®¡ç†</a>
            </nav>
            <!-- å³ä¾§æ§åˆ¶åŒºåŸŸ -->
            <div class="navbar-right">
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="navbar-controls">
                    <button class="btn btn-primary btn-sm" onclick="fetchData()">
                        <i class="fa fa-sync-alt"></i> åˆ·æ–°
                    </button>
                    <button class="btn btn-info btn-sm" onclick="copyJsonData()">
                        <i class="fa fa-copy"></i> ä¿å­˜æ›´æ”¹
                    </button>
                    <a href="index.html" class="btn btn-secondary btn-sm">
                        <i class="fa fa-home"></i> è¿”å›ä¸»é¡µ
                    </a>
                    <span id="data-status" style="color: var(--text-light); font-size: 14px; margin-left: var(--spacing-sm);">æ•°æ®åŠ è½½ä¸­...</span>
                </div>
                <!-- æ±‰å ¡èœå•æŒ‰é’® -->
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <!-- è®¾ç½®æŒ‰é’®å’Œèœå• -->
                <div class="settings-container hidden">
                    <button id="settingsBtn" class="settings-btn">âš™ï¸</button>
                    <div id="settingsMenu" class="settings-menu">
                        <!-- ä¸»é¢˜è®¾ç½®åˆ†ç±» -->
                        <div class="settings-category">
                            <div class="settings-category-title">ä¸»é¢˜</div>
                            <div class="settings-item">
                                <span class="settings-label">æ·±è‰²æ¨¡å¼</span>
                                <button id="themeToggle" class="theme-btn">
                                    <span class="sun-icon">â˜€ï¸</span>
                                    <span class="moon-icon">ğŸŒ™</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="admin-container">

        <!-- SAPå†…å®¹å®¹å™¨ -->
        <div class="sap-container">
            <!-- è§†é¢‘åˆ—è¡¨ -->
            <div class="admin-card sap-section active" id="videos">
                <div class="admin-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>è§†é¢‘åˆ—è¡¨</h2>
                        <button class="btn btn-success btn-sm" onclick="showAddVideoModal()">
                            <i class="fa fa-plus"></i> æ·»åŠ è§†é¢‘
                        </button>
                    </div>
                </div>
                <div class="admin-card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" style="background-color: var(--card-bg);">
                            <thead style="background-color: var(--primary-purple); color: white;">
                                <tr>
                                    <th>æ¸¸æˆ</th>
                                    <th>ç« èŠ‚</th>
                                    <th>è§†é¢‘ID</th>
                                    <th>æ ‡é¢˜</th>
                                    <th>æ—¶é•¿</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="videos-table-body">
                                <tr>
                                    <td colspan="8" class="text-center" style="color: var(--text-medium);">æ•°æ®åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- é€šçŸ¥åˆ—è¡¨ -->
            <div class="admin-card sap-section" id="notifications">
                <div class="admin-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>é€šçŸ¥åˆ—è¡¨</h2>
                        <button class="btn btn-danger btn-sm" onclick="showAddNotificationModal()">
                            <i class="fa fa-bell"></i> æ·»åŠ é€šçŸ¥
                        </button>
                    </div>
                </div>
                <div class="admin-card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" style="background-color: var(--card-bg);">
                            <thead style="background-color: var(--primary-purple); color: white;">
                                <tr>
                                    <th>ID</th>
                                    <th>æ ‡é¢˜</th>
                                    <th>å†…å®¹</th>
                                    <th>ç±»å‹</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="notifications-table-body">
                                <tr>
                                    <td colspan="6" class="text-center" style="color: var(--text-medium);">æ•°æ®åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ›´æ–°é¢„å‘Š -->
            <div class="admin-card sap-section" id="update-preview">
                <div class="admin-card-header">
                    <h2>æ›´æ–°é¢„å‘Š</h2>
                </div>
                <div class="admin-card-body">
                    <div id="update-preview-content">
                        <p style="color: var(--text-medium);">åŠ è½½ä¸­...</p>
                    </div>
                    <button class="btn btn-primary" onclick="showUpdatePreviewModal()">
                        <i class="fa fa-edit"></i> ç¼–è¾‘æ›´æ–°é¢„å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ›´æ–°é¢„å‘Šç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="updatePreviewModal" tabindex="-1" role="dialog" aria-labelledby="updatePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updatePreviewModalLabel">ç¼–è¾‘æ›´æ–°é¢„å‘Š</h5>
                </div>
                <div class="modal-body">
                    <form id="updatePreviewForm">
                        <div class="form-group">
                            <label for="updateTitle">æ ‡é¢˜</label>
                            <input type="text" class="form-control" id="updateTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="timeSelect">æ—¶é—´ç±»å‹</label>
                            <select class="form-control" id="timeSelect" required>
                                <option value="time">æ—¶é—´</option>
                                <option value="pending">å¾…å®š</option>
                            </select>
                        </div>
                        <div class="form-group" id="timeInputGroup">
                            <label for="updateTime">æ—¶é—´</label>
                            <input type="datetime-local" class="form-control" id="updateTime">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="saveUpdatePreview()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘é€šçŸ¥æ¨¡æ€æ¡† -->
    <div class="modal fade" id="notificationModal" tabindex="-1" role="dialog" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">æ·»åŠ é€šçŸ¥</h5>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <input type="hidden" id="notificationId">
                        <div class="form-group">
                            <label for="notificationTitle">æ ‡é¢˜</label>
                            <input type="text" class="form-control" id="notificationTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="notificationContent">å†…å®¹</label>
                            <textarea class="form-control" id="notificationContent" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="notificationType">ç±»å‹</label>
                            <select class="form-control" id="notificationType" required>
                                <option value="warning">è­¦å‘Š</option>
                                <option value="info">ä¿¡æ¯</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notificationDate">æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="notificationDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="saveNotification()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è§†é¢‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="videoModal" tabindex="-1" role="dialog" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalLabel">æ·»åŠ è§†é¢‘</h5>
                </div>
                <div class="modal-body">
                    <form id="videoForm">
                        <input type="hidden" id="videoIndex">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="videoGame">æ¸¸æˆ</label>
                                    <select class="form-control" id="videoGame" required>
                                        <option value="undertale">Undertale</option>
                                        <option value="deltarune">Deltarune</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="videoChapter">ç« èŠ‚</label>
                                    <input type="text" class="form-control" id="videoChapter" required>
                                </div>
                                <div class="form-group">
                                    <label for="videoId">è§†é¢‘ID</label>
                                    <input type="text" class="form-control" id="videoId" required>
                                </div>
                                <div class="form-group">
                                    <label for="videoThumbnail">ç¼©ç•¥å›¾URL</label>
                                    <input type="text" class="form-control" id="videoThumbnail" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="videoTitle">æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="videoTitle" required>
                                </div>
                                <div class="form-group">
                                    <label for="videoDuration">æ—¶é•¿</label>
                                    <input type="text" class="form-control" id="videoDuration" required>
                                </div>
                                <div class="form-group">
                                    <label for="videoDate">æ—¥æœŸ</label>
                                    <input type="datetime-local" class="form-control" id="videoDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="videoStatus">çŠ¶æ€</label>
                                    <select class="form-control" id="videoStatus" required>
                                        <option value="å·²å‘å¸ƒ">å·²å‘å¸ƒ</option>
                                        <option value="å¼‚å¸¸">å¼‚å¸¸</option>
                                        <option value="å®¡æ ¸ä¸­">å®¡æ ¸ä¸­</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="videoErrorReason">é”™è¯¯åŸå› ï¼ˆä»…å½“çŠ¶æ€ä¸ºå¼‚å¸¸æ—¶ï¼‰</label>
                            <input type="text" class="form-control" id="videoErrorReason">
                        </div>
                        <div class="form-group">
                            <label for="videoSpoiler">å‰§é€è­¦å‘Š</label>
                            <input type="checkbox" id="videoSpoiler">
                            <span>å¯ç”¨å‰§é€è­¦å‘Š</span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="saveVideo()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">ç¡®è®¤åˆ é™¤</h5>
                </div>
                <div class="modal-body">
                    ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteVideo()">åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤åˆ¶æˆåŠŸæç¤ºæ¨¡æ€æ¡† -->
    <div class="modal fade" id="copySuccessModal" tabindex="-1" role="dialog" aria-labelledby="copySuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="copySuccessModalLabel">æ“ä½œæˆåŠŸ</h5>
                </div>
                <div class="modal-body">
                    JSONæ•°æ®å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤é€šçŸ¥ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteNotificationModal" tabindex="-1" role="dialog" aria-labelledby="deleteNotificationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteNotificationModalLabel">ç¡®è®¤åˆ é™¤</h5>
                </div>
                <div class="modal-body">
                    ç¡®å®šè¦åˆ é™¤è¿™æ¡é€šçŸ¥å—ï¼Ÿ
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteNotification()">åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥jQueryå’ŒBootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- å¼•å…¥å…¨å±€è„šæœ¬ -->
    <script src="js/script.js"></script>

    <script>
        // å…¨å±€æ•°æ®å˜é‡
        let allData = {
            update_preview: {},
            notifications: [],
            videos: []
        };
        
        // å­˜å‚¨è¦åˆ é™¤çš„è§†é¢‘ç´¢å¼•
        let videoIndexToDelete = null;
        
        // å­˜å‚¨è¦åˆ é™¤çš„é€šçŸ¥ç´¢å¼•
        let notificationIndexToDelete = null;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        $(document).ready(function() {
            fetchData();
            // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼åŠŸèƒ½
            initDarkMode();
            
            // æ—¶é—´ç±»å‹é€‰æ‹©äº‹ä»¶
            const timeSelect = document.getElementById('timeSelect');
            const timeInputGroup = document.getElementById('timeInputGroup');
            const updateTime = document.getElementById('updateTime');
            
            if (timeSelect) {
                timeSelect.addEventListener('change', function() {
                    if (this.value === 'time') {
                        timeInputGroup.style.display = 'block';
                    } else {
                        timeInputGroup.style.display = 'none';
                        updateTime.value = '';
                    }
                });
            }
        });

        // ä»APIè·å–æ•°æ®
        async function fetchData() {
            try {
                const response = await fetch('/api/fetch_data');
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                allData = await response.json();
                renderAllData();
                document.getElementById('data-status').innerHTML = '<span class="text-success">æ•°æ®åŠ è½½æˆåŠŸ</span>';
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                document.getElementById('data-status').innerHTML = '<span class="text-danger">æ•°æ®åŠ è½½å¤±è´¥ï¼š' + error.message + '</span>';
                // å°è¯•ä»æœ¬åœ°æ–‡ä»¶è·å–æ•°æ®
                try {
                    const localResponse = await fetch('data.json');
                    if (localResponse.ok) {
                        allData = await localResponse.json();
                        renderAllData();
                        document.getElementById('data-status').innerHTML = '<span class="text-warning">å·²åŠ è½½æœ¬åœ°æ•°æ®</span>';
                    }
                } catch (localError) {
                    console.error('è·å–æœ¬åœ°æ•°æ®å¤±è´¥:', localError);
                }
            }
        }

        // æ¸²æŸ“æ‰€æœ‰æ•°æ®
        function renderAllData() {
            renderUpdatePreview();
            renderNotifications();
            renderVideos();
        }

        // æ¸²æŸ“æ›´æ–°é¢„å‘Š
        function renderUpdatePreview() {
            const preview = allData.update_preview || {};
            const content = document.getElementById('update-preview-content');
            const displayTime = preview.time ? formatDateTime(preview.time) : 'å¾…å®š';
            content.innerHTML = `
                <h3 style="color: var(--text-dark);">${preview.title || 'æš‚æ— æ›´æ–°é¢„å‘Š'}</h3>
                <p style="color: var(--text-medium);">æ—¶é—´ï¼š${displayTime}</p>
            `;
        }

        // æ¸²æŸ“é€šçŸ¥åˆ—è¡¨
        function renderNotifications() {
            const tbody = document.getElementById('notifications-table-body');
            const notifications = allData.notifications || [];

            if (notifications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">æš‚æ— é€šçŸ¥</td></tr>';
                return;
            }

            tbody.innerHTML = notifications.map((notification, index) => `
                <tr>
                    <td>${notification.id || index + 1}</td>
                    <td>${notification.title}</td>
                    <td>${notification.content}</td>
                    <td><span class="status-badge status-${notification.type}">${notification.type}</span></td>
                    <td>${formatDate(notification.date)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm btn-action" onclick="editNotification(${index})"><i class="fa fa-edit"></i> ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm btn-action" onclick="deleteNotification(${index})"><i class="fa fa-trash"></i> åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');

        }

        // æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼šå°†æ—¥æœŸå¯¹è±¡æˆ–å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸ºæ ‡å‡†æ ¼å¼
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            
            // å¤„ç†ä¸åŒæ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²
            let dateObj;
            if (dateStr.includes('T')) {
                // YYYY-MM-DDThh:mmæ ¼å¼
                dateObj = new Date(dateStr);
            } else if (dateStr.includes(' ')) {
                // YYYY-MM-DD HH:MMæ ¼å¼
                dateObj = new Date(dateStr.replace(' ', 'T'));
            } else {
                // YYYY-MM-DDæ ¼å¼
                dateObj = new Date(dateStr);
            }
            
            if (isNaN(dateObj.getTime())) return dateStr;
            
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const hours = String(dateObj.getHours()).padStart(2, '0');
            const minutes = String(dateObj.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°ï¼šå°†æ—¥æœŸå¯¹è±¡æˆ–å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸ºæ ‡å‡†æ—¥æœŸæ ¼å¼ï¼ˆä»…æ—¥æœŸï¼Œæ— æ—¶é—´ï¼‰
        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            // å¤„ç†ä¸åŒæ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²
            let dateObj;
            if (dateStr.includes('T')) {
                // YYYY-MM-DDThh:mmæ ¼å¼
                dateObj = new Date(dateStr);
            } else if (dateStr.includes(' ')) {
                // YYYY-MM-DD HH:MMæ ¼å¼
                dateObj = new Date(dateStr.replace(' ', 'T'));
            } else {
                // YYYY-MM-DDæ ¼å¼
                dateObj = new Date(dateStr);
            }
            
            if (isNaN(dateObj.getTime())) return dateStr;
            
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // æ—¥æœŸæ—¶é—´æ ¼å¼éªŒè¯å‡½æ•°
        function validateDateTimeFormat(dateTimeStr) {
            if (!dateTimeStr) return true;
            
            // éªŒè¯æ—¶é—´æ ¼å¼ï¼šYYYY-MM-DD HH:MM
            const timeRegex = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/;
            
            return timeRegex.test(dateTimeStr);
        }

        function renderVideos() {
            const tbody = document.getElementById('videos-table-body');
            const videos = allData.videos || [];

            if (videos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">æš‚æ— è§†é¢‘</td></tr>';
                return;
            }

            tbody.innerHTML = videos.map((video, index) => `
                <tr>
                    <td><span class="game-tag game-${video.game}">${video.game}</span></td>
                    <td>${video.chapter}</td>
                    <td>${video.video_id}</td>
                    <td>${video.title}</td>
                    <td>${video.duration}</td>
                    <td>${formatDateTime(video.date)}</td>
                    <td><span class="status-badge status-${video.status === 'å·²å‘å¸ƒ' ? 'published' : video.status === 'å¼‚å¸¸' ? 'error' : 'warning'}">${video.status}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm btn-action" onclick="editVideo(${index})"><i class="fa fa-edit"></i> ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm btn-action" onclick="deleteVideo(${index})"><i class="fa fa-trash"></i> åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');

        }

        // æ˜¾ç¤ºæ›´æ–°é¢„å‘Šç¼–è¾‘æ¨¡æ€æ¡†
        function showUpdatePreviewModal() {
            const preview = allData.update_preview || {};
            document.getElementById('updateTitle').value = preview.title || '';
            
            // å¤„ç†æ—¶é—´å€¼æ ¼å¼
            const updateTime = document.getElementById('updateTime');
            const timeValue = preview.time || '';
            
            if (timeValue) {
                // å°†YYYY-MM-DD HH:MMæ ¼å¼è½¬æ¢ä¸ºYYYY-MM-DDThh:mmæ ¼å¼
                const formattedTime = timeValue.replace(' ', 'T');
                updateTime.value = formattedTime;
            } else {
                updateTime.value = '';
            }
            
            // æ ¹æ®ç°æœ‰æ—¶é—´å€¼è®¾ç½®ä¸‹æ‹‰åˆ—è¡¨
            const timeSelect = document.getElementById('timeSelect');
            const timeInputGroup = document.getElementById('timeInputGroup');
            
            if (updateTime.value) {
                timeSelect.value = 'time';
                timeInputGroup.style.display = 'block';
            } else {
                timeSelect.value = 'pending';
                timeInputGroup.style.display = 'none';
            }
            
            $('#updatePreviewModal').modal('show');
        }

        // ä¿å­˜æ›´æ–°é¢„å‘Š
        function saveUpdatePreview() {
            const updateTime = document.getElementById('updateTime').value;
            let formattedTime = '';
            
            if (updateTime) {
                // å°†YYYY-MM-DDThh:mmæ ¼å¼è½¬æ¢ä¸ºYYYY-MM-DD HH:MMæ ¼å¼
                formattedTime = updateTime.replace('T', ' ');
                
                // éªŒè¯æ—¶é—´æ ¼å¼
                if (!validateDateTimeFormat(formattedTime)) {
                    alert('æ—¶é—´æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼ï¼šyyyy-mm-dd hh:mm');
                    return;
                }
            }
            
            allData.update_preview = {
                title: document.getElementById('updateTitle').value,
                time: formattedTime
            };
            renderUpdatePreview();
            $('#updatePreviewModal').modal('hide');
        }

        // æ˜¾ç¤ºæ·»åŠ é€šçŸ¥æ¨¡æ€æ¡†
        function showAddNotificationModal() {
            document.getElementById('notificationModalLabel').textContent = 'æ·»åŠ é€šçŸ¥';
            document.getElementById('notificationForm').reset();
            document.getElementById('notificationId').value = '';
            $('#notificationModal').modal('show');
        }

        // ç¼–è¾‘é€šçŸ¥
        function editNotification(index) {
            const notification = allData.notifications[index];
            document.getElementById('notificationModalLabel').textContent = 'ç¼–è¾‘é€šçŸ¥';
            document.getElementById('notificationId').value = index;
            document.getElementById('notificationTitle').value = notification.title;
            document.getElementById('notificationContent').value = notification.content;
            document.getElementById('notificationType').value = notification.type;
            // ç¡®ä¿æ—¥æœŸæ ¼å¼ä¸ºYYYY-MM-DDï¼Œé€‚é…dateè¾“å…¥
            let dateValue = notification.date;
            if (dateValue.includes(' ')) {
                dateValue = dateValue.split(' ')[0];
            }
            document.getElementById('notificationDate').value = dateValue;
            $('#notificationModal').modal('show');
        }

        // ä¿å­˜é€šçŸ¥
        function saveNotification() {
            const index = document.getElementById('notificationId').value;
            let notificationDate = document.getElementById('notificationDate').value;
            
            // éªŒè¯æ—¥æœŸæ ¼å¼ï¼ˆYYYY-MM-DDï¼‰
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(notificationDate)) {
                alert('æ—¥æœŸæ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼ï¼šyyyy-mm-dd');
                return;
            }
            
            const notification = {
                id: parseInt(index) + 1 || allData.notifications.length + 1,
                title: document.getElementById('notificationTitle').value,
                content: document.getElementById('notificationContent').value,
                type: document.getElementById('notificationType').value,
                date: notificationDate
            };

            if (index) {
                allData.notifications[parseInt(index)] = notification;
            } else {
                allData.notifications.push(notification);
            }

            renderNotifications();
            $('#notificationModal').modal('hide');
        }

        // åˆ é™¤é€šçŸ¥
        function deleteNotification(index) {
            // å­˜å‚¨è¦åˆ é™¤çš„é€šçŸ¥ç´¢å¼•
            notificationIndexToDelete = index;
            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
            $('#deleteNotificationModal').modal('show');
        }
        
        // ç¡®è®¤åˆ é™¤é€šçŸ¥
        function confirmDeleteNotification() {
            if (notificationIndexToDelete !== null) {
                allData.notifications.splice(notificationIndexToDelete, 1);
                renderNotifications();
                // å…³é—­æ¨¡æ€æ¡†
                $('#deleteNotificationModal').modal('hide');
                // é‡ç½®ç´¢å¼•
                notificationIndexToDelete = null;
            }
        }

        // æ˜¾ç¤ºæ·»åŠ è§†é¢‘æ¨¡æ€æ¡†
        function showAddVideoModal() {
            document.getElementById('videoModalLabel').textContent = 'æ·»åŠ è§†é¢‘';
            document.getElementById('videoForm').reset();
            document.getElementById('videoIndex').value = '';
            $('#videoModal').modal('show');
        }

        // ç¼–è¾‘è§†é¢‘
        function editVideo(index) {
            const video = allData.videos[index];
            document.getElementById('videoModalLabel').textContent = 'ç¼–è¾‘è§†é¢‘';
            document.getElementById('videoIndex').value = index;
            document.getElementById('videoGame').value = video.game;
            document.getElementById('videoChapter').value = video.chapter;
            document.getElementById('videoId').value = video.video_id;
            document.getElementById('videoThumbnail').value = video.thumbnail;
            document.getElementById('videoTitle').value = video.title;
            document.getElementById('videoDuration').value = video.duration;
            // è½¬æ¢YYYY-MM-DD HH:MMæ ¼å¼ä¸ºYYYY-MM-DDThh:mmæ ¼å¼ï¼Œé€‚é…datetime-localè¾“å…¥
            let dateValue = video.date;
            if (dateValue.includes(' ')) {
                dateValue = dateValue.replace(' ', 'T');
            }
            document.getElementById('videoDate').value = dateValue;
            document.getElementById('videoStatus').value = video.status;
            document.getElementById('videoErrorReason').value = video.error_reason || '';
            document.getElementById('videoSpoiler').checked = video.spoiler || false;
            $('#videoModal').modal('show');
        }

        // ä¿å­˜è§†é¢‘
        function saveVideo() {
            const index = document.getElementById('videoIndex').value;
            let videoDate = document.getElementById('videoDate').value;
            
            // è½¬æ¢datetime-localæ ¼å¼ä¸ºYYYY-MM-DD HH:MM
            if (videoDate.includes('T')) {
                videoDate = videoDate.replace('T', ' ');
            }
            
            // éªŒè¯æ—¥æœŸæ—¶é—´æ ¼å¼
            if (!validateDateTimeFormat(videoDate)) {
                alert('æ—¥æœŸæ—¶é—´æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼ï¼šyyyy-mm-dd hh:mm');
                return;
            }
            
            const video = {
                game: document.getElementById('videoGame').value,
                chapter: document.getElementById('videoChapter').value,
                video_id: document.getElementById('videoId').value,
                thumbnail: document.getElementById('videoThumbnail').value,
                title: document.getElementById('videoTitle').value,
                duration: document.getElementById('videoDuration').value,
                date: videoDate,
                status: document.getElementById('videoStatus').value,
                tags: [document.getElementById('videoGame').value === 'undertale' ? 'Undertale' : 'Deltarune'],
                error_reason: document.getElementById('videoStatus').value === 'å¼‚å¸¸' ? document.getElementById('videoErrorReason').value : undefined,
                spoiler: document.getElementById('videoSpoiler').checked
            };

            if (index) {
                allData.videos[parseInt(index)] = video;
            } else {
                allData.videos.push(video);
            }

            renderVideos();
            $('#videoModal').modal('hide');
        }

        // åˆ é™¤è§†é¢‘
        function deleteVideo(index) {
            // å­˜å‚¨è¦åˆ é™¤çš„è§†é¢‘ç´¢å¼•
            videoIndexToDelete = index;
            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
            $('#deleteConfirmModal').modal('show');
        }
        
        // ç¡®è®¤åˆ é™¤è§†é¢‘
        function confirmDeleteVideo() {
            if (videoIndexToDelete !== null) {
                allData.videos.splice(videoIndexToDelete, 1);
                renderVideos();
                // å…³é—­æ¨¡æ€æ¡†
                $('#deleteConfirmModal').modal('hide');
                // é‡ç½®ç´¢å¼•
                videoIndexToDelete = null;
            }
        }

        // å¤åˆ¶JSONæ•°æ®åˆ°å‰ªè´´æ¿
        function copyJsonData() {
            try {
                // åˆ›å»ºæ•°æ®å‰¯æœ¬ï¼Œä¿æŒåŸå§‹æ•°æ®ä¸å˜
                const dataCopy = JSON.parse(JSON.stringify(allData));
                
                // ç¡®ä¿è§†é¢‘æ—¥æœŸæ ¼å¼ä¸€è‡´
                if (dataCopy.videos && Array.isArray(dataCopy.videos)) {
                    dataCopy.videos.forEach(video => {
                        if (video.date) {
                            video.date = formatDateTime(video.date);
                        }
                    });
                }
                
                // ç¡®ä¿é€šçŸ¥æ—¥æœŸæ ¼å¼ä¸€è‡´
                if (dataCopy.notifications && Array.isArray(dataCopy.notifications)) {
                    dataCopy.notifications.forEach(notification => {
                        if (notification.date) {
                            notification.date = formatDate(notification.date);
                        }
                    });
                }
                
                // ç¡®ä¿æ›´æ–°é¢„å‘Šæ—¶é—´æ ¼å¼ä¸€è‡´
                if (dataCopy.update_preview && dataCopy.update_preview.time) {
                    dataCopy.update_preview.time = formatDateTime(dataCopy.update_preview.time);
                }
                
                // æ·»åŠ ä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼Œç²¾ç¡®åˆ°æ—¥
                const now = new Date();
                const lastUpdated = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                dataCopy.last_updated = lastUpdated;
                
                const jsonString = JSON.stringify(dataCopy, null, 2);
                navigator.clipboard.writeText(jsonString).then(() => {
                    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæ¨¡æ€æ¡†
                    $('#copySuccessModal').modal('show');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ•°æ®ã€‚');
                    // æä¾›ä¸€ä¸ªå¤‡ç”¨çš„å¤åˆ¶æ–¹æ³•
                    const textarea = document.createElement('textarea');
                    textarea.value = jsonString;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                });
            } catch (error) {
                console.error('å¤åˆ¶æ•°æ®å¤±è´¥:', error);
                alert('å¤åˆ¶æ•°æ®å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // SAPæ¨¡å¼æ¿å—åˆ‡æ¢å‡½æ•°
        function switchSection(sectionId, event) {
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé“¾æ¥çš„activeç±»
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            // ä¸ºå½“å‰ç‚¹å‡»çš„å¯¼èˆªé“¾æ¥æ·»åŠ activeç±»
            event.target.classList.add('active');
            
            // éšè—æ‰€æœ‰çš„sap-section
            const sections = document.querySelectorAll('.sap-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // æ˜¾ç¤ºå½“å‰é€‰æ‹©çš„sap-section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }
    </script>
</body>
</html>